#!/bin/bash

# ==========================================
# ğŸš€ Ø¯ÛŒÙ¾Ù„ÙˆÛŒ Ø³Ø±ÛŒØ¹ - ÛŒÚ© Ø¯Ø³ØªÙˆØ±ÛŒ
# ==========================================

set -e

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸš€ Ø¯ÛŒÙ¾Ù„ÙˆÛŒ Ø³Ø±ÛŒØ¹ CRM System"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

# ==========================================
# Ù…Ø±Ø­Ù„Ù‡ 1: Ø¨Ø±Ø±Ø³ÛŒ Ù¾ÛŒØ´â€ŒÙ†ÛŒØ§Ø²Ù‡Ø§
# ==========================================
echo "1ï¸âƒ£  Ø¨Ø±Ø±Ø³ÛŒ Ù¾ÛŒØ´â€ŒÙ†ÛŒØ§Ø²Ù‡Ø§..."

if ! command -v docker &> /dev/null; then
    echo "   âŒ Docker Ù†ØµØ¨ Ù†ÛŒØ³Øª!"
    exit 1
fi
echo "   âœ… Docker Ù†ØµØ¨ Ø§Ø³Øª"

if ! command -v docker-compose &> /dev/null; then
    echo "   âŒ Docker Compose Ù†ØµØ¨ Ù†ÛŒØ³Øª!"
    exit 1
fi
echo "   âœ… Docker Compose Ù†ØµØ¨ Ø§Ø³Øª"

# ==========================================
# Ù…Ø±Ø­Ù„Ù‡ 2: ØªÙ†Ø¸ÛŒÙ… .env
# ==========================================
echo ""
echo "2ï¸âƒ£  ØªÙ†Ø¸ÛŒÙ… ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ .env..."

if [ ! -f ".env" ]; then
    echo "   ğŸ“ Ø§ÛŒØ¬Ø§Ø¯ .env..."
    bash setup-all-env.sh
else
    echo "   âœ… .env Ù…ÙˆØ¬ÙˆØ¯ Ø§Ø³Øª"
    read -p "   Ø¢ÛŒØ§ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ .env Ø±Ø§ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø¨Ø³Ø§Ø²ÛŒØ¯ØŸ (y/N): " RECREATE_ENV
    if [ "$RECREATE_ENV" = "y" ] || [ "$RECREATE_ENV" = "Y" ]; then
        bash setup-all-env.sh
    fi
fi

# ==========================================
# Ù…Ø±Ø­Ù„Ù‡ 3: Ø¨Ø±Ø±Ø³ÛŒ ØªÙ†Ø¸ÛŒÙ…Ø§Øª
# ==========================================
echo ""
echo "3ï¸âƒ£  Ø¨Ø±Ø±Ø³ÛŒ ØªÙ†Ø¸ÛŒÙ…Ø§Øª..."

if bash verify-all-configs.sh; then
    echo "   âœ… Ù‡Ù…Ù‡ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø¯Ø±Ø³Øª Ø§Ø³Øª"
else
    echo "   âŒ Ø®Ø·Ø§ Ø¯Ø± ØªÙ†Ø¸ÛŒÙ…Ø§Øª!"
    echo ""
    echo "Ù„Ø·ÙØ§Ù‹ Ø®Ø·Ø§Ù‡Ø§ Ø±Ø§ Ø§ØµÙ„Ø§Ø­ Ú©Ù†ÛŒØ¯ Ùˆ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø§Ø¬Ø±Ø§ Ú©Ù†ÛŒØ¯:"
    echo "   bash deploy-quick.sh"
    exit 1
fi

# ==========================================
# Ù…Ø±Ø­Ù„Ù‡ 4: Ø§Ù†ØªØ®Ø§Ø¨ Ù†ÙˆØ¹ Ø¯ÛŒÙ¾Ù„ÙˆÛŒ
# ==========================================
echo ""
echo "4ï¸âƒ£  Ø§Ù†ØªØ®Ø§Ø¨ Ù†ÙˆØ¹ Ø¯ÛŒÙ¾Ù„ÙˆÛŒ..."
echo ""
echo "   1) Ø¯ÛŒÙ¾Ù„ÙˆÛŒ Ù…Ø¹Ù…ÙˆÙ„ÛŒ (Ø³Ø±ÛŒØ¹â€ŒØªØ±)"
echo "   2) Ø¯ÛŒÙ¾Ù„ÙˆÛŒ Ø¨Ø§ Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ú©Ø§Ù…Ù„ (Ú©Ù†Ø¯ØªØ± ÙˆÙ„ÛŒ Ù…Ø·Ù…Ø¦Ù†â€ŒØªØ±)"
echo ""
read -p "   Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯ (1 ÛŒØ§ 2) [1]: " DEPLOY_TYPE
DEPLOY_TYPE=${DEPLOY_TYPE:-1}

# ==========================================
# Ù…Ø±Ø­Ù„Ù‡ 5: Ø¯ÛŒÙ¾Ù„ÙˆÛŒ
# ==========================================
echo ""
echo "5ï¸âƒ£  Ø´Ø±ÙˆØ¹ Ø¯ÛŒÙ¾Ù„ÙˆÛŒ..."
echo ""

if [ "$DEPLOY_TYPE" = "2" ]; then
    echo "   ğŸ§¹ Ø¯ÛŒÙ¾Ù„ÙˆÛŒ Ø¨Ø§ Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ú©Ø§Ù…Ù„..."
    bash deploy-server.sh --clean
else
    echo "   ğŸš€ Ø¯ÛŒÙ¾Ù„ÙˆÛŒ Ù…Ø¹Ù…ÙˆÙ„ÛŒ..."
    bash deploy-server.sh
fi

# ==========================================
# Ù…Ø±Ø­Ù„Ù‡ 6: Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ø±Ø§ÛŒ Ø¢Ù…Ø§Ø¯Ù‡ Ø´Ø¯Ù†
# ==========================================
echo ""
echo "6ï¸âƒ£  Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ø±Ø§ÛŒ Ø¢Ù…Ø§Ø¯Ù‡ Ø´Ø¯Ù† Ø³Ø±ÙˆÛŒØ³â€ŒÙ‡Ø§..."
echo "   â³ ØµØ¨Ø± Ú©Ù†ÛŒØ¯ 30 Ø«Ø§Ù†ÛŒÙ‡..."
sleep 30

# ==========================================
# Ù…Ø±Ø­Ù„Ù‡ 7: Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª
# ==========================================
echo ""
echo "7ï¸âƒ£  Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª Ú©Ø§Ù†ØªÛŒÙ†Ø±Ù‡Ø§..."
echo ""

docker-compose ps

# ==========================================
# Ù…Ø±Ø­Ù„Ù‡ 8: ØªØ³Øª Ø³Ø±ÙˆÛŒØ³â€ŒÙ‡Ø§
# ==========================================
echo ""
echo "8ï¸âƒ£  ØªØ³Øª Ø³Ø±ÙˆÛŒØ³â€ŒÙ‡Ø§..."
echo ""

# MySQL
echo "   ğŸ—„ï¸  ØªØ³Øª MySQL..."
if docker exec crm_mysql mariadb -u root -e "SELECT 1;" >/dev/null 2>&1; then
    echo "      âœ… MySQL Ú©Ø§Ø± Ù…ÛŒâ€ŒÚ©Ù†Ø¯"
else
    echo "      âŒ MySQL Ù…Ø´Ú©Ù„ Ø¯Ø§Ø±Ø¯"
fi

# Rabin Voice
echo "   ğŸ¤ ØªØ³Øª Rabin Voice..."
if curl -s http://localhost:3001/health >/dev/null 2>&1; then
    echo "      âœ… Rabin Voice Ú©Ø§Ø± Ù…ÛŒâ€ŒÚ©Ù†Ø¯"
else
    echo "      âš ï¸  Rabin Voice Ù‡Ù†ÙˆØ² Ø¢Ù…Ø§Ø¯Ù‡ Ù†ÛŒØ³Øª"
fi

# NextJS
echo "   ğŸŒ ØªØ³Øª NextJS..."
if curl -s http://localhost:3000/api/health >/dev/null 2>&1; then
    echo "      âœ… NextJS Ú©Ø§Ø± Ù…ÛŒâ€ŒÚ©Ù†Ø¯"
else
    echo "      âš ï¸  NextJS Ù‡Ù†ÙˆØ² Ø¢Ù…Ø§Ø¯Ù‡ Ù†ÛŒØ³Øª"
fi

# ==========================================
# Ù†ØªÛŒØ¬Ù‡ Ù†Ù‡Ø§ÛŒÛŒ
# ==========================================
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ‰ Ø¯ÛŒÙ¾Ù„ÙˆÛŒ Ú©Ø§Ù…Ù„ Ø´Ø¯!"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "ğŸ“‹ Ø¢Ø¯Ø±Ø³â€ŒÙ‡Ø§ÛŒ Ø¯Ø³ØªØ±Ø³ÛŒ:"
echo ""
echo "   ğŸŒ Main App:"
echo "      http://crm.robintejarat.com/"
echo ""
echo "   ğŸ¤ Rabin Voice:"
echo "      http://crm.robintejarat.com/rabin-voice/"
echo ""
echo "   ğŸ” phpMyAdmin:"
echo "      http://crm.robintejarat.com/secure-db-admin-panel-x7k9m2/"
echo "      Username: root"
echo "      Password: (Ø®Ø§Ù„ÛŒ)"
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "ğŸ“Š Ø¯Ø³ØªÙˆØ±Ø§Øª Ù…ÙÛŒØ¯:"
echo ""
echo "   â€¢ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù„Ø§Ú¯â€ŒÙ‡Ø§:"
echo "     docker-compose logs -f"
echo ""
echo "   â€¢ Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª:"
echo "     docker-compose ps"
echo ""
echo "   â€¢ Ø±ÛŒâ€ŒØ§Ø³ØªØ§Ø±Øª:"
echo "     docker-compose restart"
echo ""
echo "   â€¢ ØªØ³Øª Ú©Ø§Ù…Ù„:"
echo "     bash quick-test.sh"
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
