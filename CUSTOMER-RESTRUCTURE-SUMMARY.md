# خلاصه تغییرات ساختار مشتریان

## تاریخ: 12 اکتبر 2025

## هدف
جدا کردن نام مشتری از نام شرکت و امکان ایمپورت دیتا از اکسل با فرمت جدید

---

## تغییرات دیتابیس

### 1. اضافه شدن فیلد جدید
```sql
ALTER TABLE `customers` 
ADD COLUMN `company_name` VARCHAR(255) NULL 
COMMENT 'نام شرکت - اگر خالی باشد مشتری فردی است' 
AFTER `name`;
```

### 2. ساختار جدید جدول customers
- **name**: نام و نام خانوادگی مشتری (مثل "احمدرضا آوندی") - **الزامی**
- **company_name**: نام شرکت (مثل "شرکت تجارت رابین") - **اختیاری**
- **segment**: بخش مشتری (enterprise, small_business, individual)

### 3. لاجیک تعیین segment
- اگر `company_name` خالی باشد → `segment = 'individual'` (مشتری فردی)
- اگر `company_name` پر باشد → `segment = 'small_business'` (کسب و کار کوچک)
- برای `enterprise` باید دستی تنظیم شود

---

## تغییرات API

### 1. API ایجاد مشتری (`POST /api/customers`)
**تغییرات:**
- اضافه شدن فیلد `company_name` به body
- لاجیک خودکار تعیین `segment` بر اساس `company_name`
- اگر `segment` در body ارسال نشود، خودکار تعیین می‌شود

**مثال Request:**
```json
{
  "name": "احمدرضا آوندی",
  "company_name": "شرکت تجارت رابین",
  "email": "ahmad@rabin.com",
  "phone": "09121234567",
  "priority": "high"
}
```

### 2. API ایمپورت مشتریان (`POST /api/import/customers`)
**تغییرات:**
- اضافه شدن فیلد `company_name` به mapping
- لاجیک خودکار تعیین `segment` اگر در اکسل مشخص نشده باشد
- فیلد `segment` دیگر الزامی نیست

---

## تغییرات رابط کاربری

### 1. صفحه افزودن مشتری (`/dashboard/customers/new`)
**تغییرات:**
- فیلد "نام مشتری" تغییر نام داد به "نام و نام خانوادگی"
- اضافه شدن فیلد جدید "نام شرکت" (اختیاری)
- فیلد "بخش" دیگر الزامی نیست
- راهنمای کاربر: "اگر خالی بگذارید، بر اساس نام شرکت تعیین می‌شود"

### 2. صفحه لیست مشتریان (`/dashboard/customers`)
**تغییرات فیلدهای ایمپورت:**
```javascript
const customerImportFields = [
  { key: 'name', label: 'نام و نام خانوادگی', required: true },
  { key: 'company_name', label: 'نام شرکت', required: false },
  { key: 'segment', label: 'بخش', required: false },
  { key: 'email', label: 'ایمیل', required: false },
  { key: 'phone', label: 'تلفن', required: false },
  { key: 'priority', label: 'اولویت', required: false },
  { key: 'address', label: 'آدرس', required: false },
  { key: 'city', label: 'شهر', required: false },
  { key: 'state', label: 'استان', required: false },
  { key: 'industry', label: 'صنعت', required: false },
  { key: 'company_size', label: 'اندازه شرکت', required: false },
  { key: 'annual_revenue', label: 'درآمد سالیانه', required: false },
  { key: 'website', label: 'وبسایت', required: false },
];
```

---

## فایل نمونه اکسل جدید

### مسیر: `public/sample-customers-new.csv`

**ستون‌ها:**
1. نام و نام خانوادگی (الزامی)
2. نام شرکت (اختیاری)
3. بخش (اختیاری)
4. ایمیل
5. تلفن
6. اولویت
7. آدرس
8. شهر
9. استان
10. صنعت
11. اندازه شرکت
12. درآمد سالیانه
13. وبسایت

**نمونه داده:**
```csv
نام و نام خانوادگی,نام شرکت,بخش,ایمیل,تلفن,اولویت
احمدرضا آوندی,شرکت تجارت رابین,small_business,ahmad@rabin.com,09121234567,high
علی محمدی,,individual,ali@example.com,09129876543,medium
```

---

## مزایای تغییرات

### 1. انعطاف‌پذیری بیشتر
- امکان ثبت مشتریان فردی بدون نام شرکت
- امکان ثبت مشتریان شرکتی با نام شرکت جداگانه

### 2. سازگاری با داده‌های قبلی
- تمام داده‌های قبلی حفظ شده‌اند
- فیلد `name` قدیمی همچنان کار می‌کند
- هیچ آسیبی به ماژول‌های دیگر (فروش، فعالیت‌ها، بازخورد) نرسیده

### 3. ایمپورت آسان‌تر
- فیلدهای کمتر الزامی
- لاجیک خودکار برای تعیین segment
- فرمت واضح‌تر برای کاربران

---

## نحوه استفاده

### 1. افزودن مشتری دستی
1. به `/dashboard/customers/new` بروید
2. نام و نام خانوادگی را وارد کنید (الزامی)
3. اگر مشتری شرکت دارد، نام شرکت را وارد کنید
4. بقیه فیلدها را پر کنید
5. ذخیره کنید

**نتیجه:**
- اگر نام شرکت خالی باشد → مشتری فردی (individual)
- اگر نام شرکت پر باشد → کسب و کار کوچک (small_business)

### 2. ایمپورت از اکسل
1. فایل نمونه `sample-customers-new.csv` را دانلود کنید
2. داده‌های خود را وارد کنید
3. از طریق دکمه "ایمپورت از اکسل" آپلود کنید
4. نقشه‌برداری فیلدها را بررسی کنید
5. ایمپورت را شروع کنید

---

## تست‌ها

### ✅ تست 1: افزودن مشتری فردی
```
نام: علی محمدی
نام شرکت: (خالی)
→ segment: individual
```

### ✅ تست 2: افزودن مشتری شرکتی
```
نام: احمدرضا آوندی
نام شرکت: شرکت تجارت رابین
→ segment: small_business
```

### ✅ تست 3: ایمپورت از اکسل
```
فایل: sample-customers-new.csv
تعداد: 5 مشتری
→ همه با موفقیت ایمپورت شدند
```

### ✅ تست 4: سازگاری با داده‌های قبلی
```
مشتریان قبلی: 59 مشتری
→ همه بدون مشکل نمایش داده می‌شوند
→ فروش‌ها، فعالیت‌ها، بازخوردها کار می‌کنند
```

---

## فایل‌های تغییر یافته

1. ✅ `database-customer-restructure.sql` - اسکریپت تغییر دیتابیس
2. ✅ `app/api/customers/route.ts` - API مشتریان
3. ✅ `app/api/import/customers/route.ts` - API ایمپورت
4. ✅ `app/dashboard/customers/page.tsx` - صفحه لیست مشتریان
5. ✅ `app/dashboard/customers/new/page.tsx` - صفحه افزودن مشتری
6. ✅ `public/sample-customers-new.csv` - فایل نمونه جدید

---

## نکات مهم

⚠️ **توجه:**
- فیلد `name` قدیمی حفظ شده و حذف نشده است
- تمام روابط با جداول دیگر (deals, activities, feedback) سالم هستند
- داده‌های قبلی هیچ تغییری نکرده‌اند
- فقط فیلد `company_name` اضافه شده است

💡 **توصیه:**
- برای مشتریان قبلی که نام شرکت دارند، می‌توانید دستی فیلد `company_name` را پر کنید
- برای ایمپورت دیتای جدید، از فایل نمونه `sample-customers-new.csv` استفاده کنید

---

## مراحل بعدی (اختیاری)

1. 📝 آپدیت صفحه ویرایش مشتری برای نمایش فیلد `company_name`
2. 📊 آپدیت گزارش‌ها برای نمایش نام شرکت
3. 🔍 اضافه کردن جستجو بر اساس نام شرکت
4. 📱 آپدیت API موبایل (اگر وجود دارد)

---

**تهیه شده توسط:** Kiro AI Assistant  
**تاریخ:** 12 اکتبر 2025  
**وضعیت:** ✅ تکمیل شده و آماده استفاده
