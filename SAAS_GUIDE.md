# 🎯 راهنمای کامل سیستم Multi-Tenant SaaS

## 📋 فهرست مطالب
1. [معماری سیستم](#معماری-سیستم)
2. [راه‌اندازی اولیه](#راه‌اندازی-اولیه)
3. [نحوه استفاده](#نحوه-استفاده)
4. [مدیریت Tenants](#مدیریت-tenants)
5. [لاگین و دسترسی](#لاگین-و-دسترسی)

---

## 🏗️ معماری سیستم

سیستم شما به صورت Multi-Tenant طراحی شده:

```
┌─────────────────────────────────────────────────────────┐
│              Master Database (saas_master)               │
│  - مدیریت تمام tenants                                  │
│  - اطلاعات اشتراک‌ها و پلن‌ها                          │
│  - Super Admin                                           │
└─────────────────────────────────────────────────────────┘
                          │
        ┌─────────────────┼─────────────────┐
        │                 │                 │
┌───────▼──────┐  ┌──────▼──────┐  ┌──────▼──────┐
│ crm_system   │  │ crm_tenant_ │  │ crm_tenant_ │
│ (rabin)      │  │  company2   │  │  company3   │
│              │  │             │  │             │
│ دیتابیس جدا  │  │ دیتابیس جدا│  │ دیتابیس جدا│
│ برای هر شرکت │  │ برای هر شرکت│  │ برای هر شرکت│
└──────────────┘  └─────────────┘  └─────────────┘
```

---

## 🚀 راه‌اندازی اولیه

### مرحله 1: راه‌اندازی Master Database

```bash
node scripts/setup-master-database.cjs
```

این اسکریپت:
- ✅ دیتابیس `saas_master` را ایجاد می‌کند
- ✅ Super Admin با اطلاعات زیر ایجاد می‌شود:
  - **Username**: `Ahmadreza.avandi`
  - **Password**: `Ahmadreza.avandi`
  - **Email**: `ahmadrezaavandi@gmail.com`
- ✅ 3 پلن پیش‌فرض ایجاد می‌شود:
  - **پایه (basic)**: 500,000 تومان/ماه
  - **حرفه‌ای (professional)**: 1,500,000 تومان/ماه
  - **سازمانی (enterprise)**: 5,000,000 تومان/ماه

### مرحله 2: ثبت دیتابیس موجود به عنوان اولین Tenant

```bash
node scripts/register-existing-tenant.cjs
```

این اسکریپت دیتابیس `crm_system` موجود را به عنوان tenant اول (rabin) ثبت می‌کند.

---

## 🎮 نحوه استفاده

### 1️⃣ ورود به پنل مدیریت (Super Admin)

**URL**: `http://localhost:3000/secret-zone-789/login`

**اطلاعات ورود**:
- Username: `Ahmadreza.avandi`
- Password: `Ahmadreza.avandi`

⚠️ **مهم**: این رمز را در production حتما تغییر دهید!

### 2️⃣ ورود به CRM (مدیر شرکت)

**URL**: `http://localhost:3000/rabin/login`

**اطلاعات ورود**:
- از اطلاعات کاربری موجود در دیتابیس `crm_system` استفاده کنید
- یا از پنل admin یک کاربر جدید ایجاد کنید

---

## 👥 مدیریت Tenants

### افزودن Tenant جدید

1. وارد پنل admin شوید: `http://localhost:3000/secret-zone-789/admin-panel`
2. روی تب "مدیریت مشتریان" کلیک کنید
3. دکمه "+ افزودن Tenant جدید" را بزنید
4. فرم را پر کنید:
   - **Tenant Key**: کلید یکتا (فقط حروف کوچک، اعداد، خط تیره)
   - **نام شرکت**: نام کامل شرکت
   - **نام مدیر**: نام مدیرعامل
   - **ایمیل مدیر**: ایمیل برای لاگین
   - **رمز عبور مدیر**: رمز عبور برای ورود (حداقل 8 کاراکتر)
   - **پلن اشتراک**: انتخاب پلن
   - **مدت اشتراک**: 1، 3، 6 یا 12 ماه

5. روی "ایجاد Tenant" کلیک کنید

### ویژگی‌های سیستم

✅ **ایزولاسیون کامل داده‌ها**: هر tenant دیتابیس جداگانه دارد
✅ **مدیریت اشتراک**: تمدید، تعلیق، فعال‌سازی
✅ **پلن‌های متنوع**: قابلیت تعریف پلن‌های مختلف
✅ **گزارش‌گیری**: آمار کامل از tenants و درآمد
✅ **امنیت بالا**: رمزنگاری اطلاعات حساس

---

## 🔐 لاگین و دسترسی

### ساختار URL ها

```
# پنل مدیریت (Super Admin)
http://localhost:3000/secret-zone-789/login
http://localhost:3000/secret-zone-789/admin-panel

# CRM هر شرکت (Tenant)
http://localhost:3000/{tenant_key}/login
http://localhost:3000/{tenant_key}/dashboard

# مثال برای شرکت رابین
http://localhost:3000/rabin/login
http://localhost:3000/rabin/dashboard
```

### سطوح دسترسی

1. **Super Admin**:
   - دسترسی به پنل مدیریت
   - مدیریت تمام tenants
   - مدیریت پلن‌ها
   - مشاهده آمار و گزارشات

2. **Tenant Admin (مدیر شرکت)**:
   - دسترسی به CRM شرکت خودش
   - مدیریت کاربران شرکت
   - مدیریت مشتریان و فروش
   - استفاده از دستیار صوتی (بسته به پلن)

---

## 🛠️ اسکریپت‌های مفید

### تعمیر دیتابیس
```bash
node scripts/repair-database.cjs
```

### بررسی Super Admin
```bash
node scripts/check-super-admin.cjs
```

### تنظیم مجدد رمز Super Admin
```bash
node scripts/fix-super-admin-password.cjs
```

### ایجاد Tenant جدید (از CLI)
```bash
node scripts/create-tenant-database.cjs [tenant_key] [company_name] [admin_email] [admin_name] [plan_key] [months]
```

مثال:
```bash
node scripts/create-tenant-database.cjs irankhodro "ایران خودرو" "admin@ikco.ir" "مدیر سیستم" "enterprise" 12
```

---

## 📊 مدیریت پلن‌های اشتراک

### مشاهده پلن‌ها

1. وارد پنل admin شوید
2. روی تب "مدیریت اشتراک‌ها" کلیک کنید
3. لیست تمام پلن‌ها نمایش داده می‌شود

### افزودن پلن جدید

1. روی دکمه "+ افزودن پلن جدید" کلیک کنید
2. اطلاعات پلن را وارد کنید:
   - کلید پلن (یکتا)
   - نام پلن
   - قیمت ماهانه و سالانه
   - محدودیت‌ها (کاربران، مشتریان، فضا)
   - ویژگی‌ها (دستیار صوتی، گزارشات پیشرفته، و...)

### غیرفعال کردن پلن

- پلن‌های غیرفعال برای tenants جدید قابل انتخاب نیستند
- tenants فعلی تحت تاثیر قرار نمی‌گیرند

---

## 🔄 مدیریت Tenant

### تمدید اشتراک

1. وارد صفحه جزئیات tenant شوید
2. روی دکمه "تمدید اشتراک" کلیک کنید
3. پلن و مدت را انتخاب کنید
4. تایید کنید

### تعلیق Tenant

- Tenant معلق شده نمی‌تواند وارد سیستم شود
- صفحه "حساب معلق شده" نمایش داده می‌شود

### حذف Tenant (Soft Delete)

- Tenant به صورت soft delete حذف می‌شود
- دیتابیس حذف نمی‌شود
- قابل بازیابی است

---

## 🎯 نکات مهم

### امنیت

⚠️ **حتما این کارها را انجام دهید**:

1. رمز Super Admin را تغییر دهید
2. `JWT_SECRET` را در production تغییر دهید
3. `DB_ENCRYPTION_KEY` را تغییر دهید
4. از HTTPS استفاده کنید
5. Backup منظم از دیتابیس‌ها بگیرید

### Performance

- هر tenant connection pool جداگانه دارد
- اطلاعات tenant در cache نگهداری می‌شود (5 دقیقه)
- Middleware سریع tenant را شناسایی می‌کند

### Monitoring

- تمام فعالیت‌های مهم log می‌شوند
- آمار کامل در پنل admin موجود است
- اشتراک‌های منقضی شده به صورت خودکار شناسایی می‌شوند

---

## 🆘 عیب‌یابی

### مشکل: نمی‌توانم وارد پنل admin شوم

**راه‌حل**:
```bash
node scripts/fix-super-admin-password.cjs
```

### مشکل: خطای دیتابیس

**راه‌حل**:
```bash
node scripts/repair-database.cjs
```

### مشکل: Tenant یافت نشد

**بررسی کنید**:
1. آیا tenant در `saas_master.tenants` ثبت شده؟
2. آیا `is_deleted = false` است؟
3. آیا `subscription_status = 'active'` است؟

---

## 📞 پشتیبانی

برای سوالات و مشکلات:
- Email: ahmadrezaavandi@gmail.com
- مستندات کامل در پوشه `docs/`

---

**نسخه**: 1.0.0  
**تاریخ**: 2024  
**توسعه‌دهنده**: احمدرضا اوندی
