#!/bin/bash

# ๐ ุงุณฺฉุฑูพุช ุฑโุงุณุชุงุฑุช ุณุฑุน ุตุฏุง ุฑุงุจู (ุจุฏูู rebuild)
set -e

DOMAIN="crm.robintejarat.com"
VOICE_SUBDOMAIN="rabin-voice"
VOICE_PORT=3001

echo "โก ุฑโุงุณุชุงุฑุช ุณุฑุน ุตุฏุง ุฑุงุจู..."
echo "๐ ุฏุงููู: $DOMAIN/$VOICE_SUBDOMAIN"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

# ุฑโุงุณุชุงุฑุช ฺฉุงูุชูุฑ rabin-voice
echo "๐ ุฑโุงุณุชุงุฑุช ฺฉุงูุชูุฑ rabin-voice..."
docker-compose restart rabin-voice

# ุตุจุฑ ุจุฑุง ุขูุงุฏู ุดุฏู
echo "โณ ุตุจุฑ ุจุฑุง ุขูุงุฏู ุดุฏู rabin-voice (10 ุซุงูู)..."
sleep 10

# ุฑโุงุณุชุงุฑุช Nginx (ุถุฑูุฑ ุจุฑุง ุงุชุตุงู ุจู ุฏุงููู)
echo ""
echo "๐ ุฑโุงุณุชุงุฑุช Nginx..."
docker-compose restart nginx

# ุตุจุฑ ุจุฑุง ุขูุงุฏู ุดุฏู Nginx
echo "โณ ุตุจุฑ ุจุฑุง ุขูุงุฏู ุดุฏู Nginx (5 ุซุงูู)..."
sleep 5

# ููุงุด ูุถุนุช
echo ""
echo "๐ ูุถุนุช ฺฉุงูุชูุฑูุง:"
docker-compose ps | grep -E "rabin-voice|nginx"

# ููุงุด ูุงฺฏโูุง ุงุฎุฑ
echo ""
echo "๐ ูุงฺฏโูุง ุงุฎุฑ rabin-voice:"
docker-compose logs --tail=15 rabin-voice

# ุชุณุช ุงุชุตุงู
echo ""
echo "๐งช ุชุณุช ุงุชุตุงู..."
if nc -z localhost $VOICE_PORT 2>/dev/null; then
    echo "   โ ูพูุฑุช $VOICE_PORT ุฏุฑ ุฏุณุชุฑุณ ุงุณุช"
else
    echo "   โ๏ธ  ูพูุฑุช $VOICE_PORT ุฏุฑ ุฏุณุชุฑุณ ูุณุช"
fi

# ุชุณุช ุงุชุตุงู ุดุจฺฉู
NETWORK_TEST=$(docker exec crm-nginx wget -q -O- --timeout=5 "http://rabin-voice:3001/rabin-voice" 2>/dev/null && echo "OK" || echo "FAIL")
if [ "$NETWORK_TEST" = "OK" ]; then
    echo "   โ ุงุชุตุงู ุดุจฺฉู Nginx -> Rabin Voice: ูููู"
else
    echo "   โ๏ธ  ุงุชุตุงู ุดุจฺฉู: ูุงูููู (ููฺฉู ุงุณุช ูุงุฒ ุจู rebuild ุฏุงุดุชู ุจุงุดุฏ)"
fi

echo ""
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "โ ุฑโุงุณุชุงุฑุช ุณุฑุน ุงูุฌุงู ุดุฏ!"
echo ""
echo "๐ ุฏุณุชุฑุณโูุง:"
echo "   ๐ ูุจ: https://$DOMAIN/$VOICE_SUBDOMAIN"
echo "   ๐ ูพูุฑุช ูุญู: http://localhost:$VOICE_PORT"
echo ""
echo "๐ก ุงฺฏุฑ ูุดฺฉู ูุฌูุฏ ุฏุงุฑุฏุ ุงุฒ ุงุณฺฉุฑูพุช rebuild ฺฉุงูู ุงุณุชูุงุฏู ฺฉูุฏ:"
echo "   ./restart-rabin-voice.sh"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"