#!/bin/bash

# ğŸ” Diagnostic Script - Ù…Ø´Ø®Øµ Ú©Ù† Ú©Ù‡ Ù…Ø´Ú©Ù„ Ú©Ø¬Ø§Ø³Øª!

set +e  # Ø§Ø¯Ø§Ù…Ù‡ Ø­ØªÛŒ Ø§Ú¯Ø± Ø®Ø·Ø§ Ø±Ø® Ø¨Ø¯Ù‡Ø¯

echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘  ğŸ” CRM & Rabin Voice Deployment Diagnostic Tool          â•‘"
echo "â•‘  ØªØ´Ø®ÛŒØµ Ù…Ø´Ú©Ù„Ø§Øª Deployment                                 â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

FAILED=0
PASSED=0

# =================== ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ Ú†Ø§Ù¾ Ù†ØªÛŒØ¬Ù‡ ===================
check_result() {
    if [ $1 -eq 0 ]; then
        echo "   âœ… PASSED"
        ((PASSED++))
    else
        echo "   âŒ FAILED"
        ((FAILED++))
    fi
}

# =================== Ø¨Ø±Ø±Ø³ÛŒ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ù…Ø­ÛŒØ· ===================
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ“‹ Ø¨Ø±Ø±Ø³ÛŒ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ù…Ø­ÛŒØ· (Environment Files)"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

echo -n "1ï¸âƒ£  ÙØ§ÛŒÙ„ .env Ø¯Ø± Ø±ÛŒØ´Ù‡ Ù¾Ø±ÙˆÚ˜Ù‡: "
[ -f .env ]
check_result $?

echo -n "2ï¸âƒ£  ÙØ§ÛŒÙ„ .env.server Ù…ÙˆØ¬ÙˆØ¯: "
[ -f .env.server ]
check_result $?

echo -n "3ï¸âƒ£  ÙØ§ÛŒÙ„ ØµØ¯Ø§ÛŒ Ø±Ø§Ø¨ÛŒÙ†/.env Ù…ÙˆØ¬ÙˆØ¯: "
[ -f "ØµØ¯Ø§ÛŒ Ø±Ø§Ø¨ÛŒÙ†/.env" ]
check_result $?

echo ""

# =================== Ø¨Ø±Ø±Ø³ÛŒ Database Password ===================
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ—„ï¸  Ø¨Ø±Ø±Ø³ÛŒ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Database"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

echo -n "4ï¸âƒ£  DATABASE_PASSWORD ØªÙ†Ø¸ÛŒÙ… Ø´Ø¯Ù‡ Ø¯Ø± .env: "
grep -q "DATABASE_PASSWORD=" .env
check_result $?

echo -n "5ï¸âƒ£  DATABASE_USER = crm_app_user: "
grep -q "DATABASE_USER=.*crm_app_user" .env
check_result $?

echo -n "6ï¸âƒ£  DATABASE_NAME = crm_system: "
grep -q "DATABASE_NAME=.*crm_system" .env
check_result $?

echo -n "7ï¸âƒ£  docker-compose.yml Ù…ÙˆØ¬ÙˆØ¯: "
[ -f docker-compose.yml ]
check_result $?

echo ""

# =================== Ø¨Ø±Ø±Ø³ÛŒ OpenRouter API Key ===================
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ” Ø¨Ø±Ø±Ø³ÛŒ OpenRouter API Key"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

if grep -q "OPENROUTER_API_KEY=" "ØµØ¯Ø§ÛŒ Ø±Ø§Ø¨ÛŒÙ†/.env"; then
    RABIN_KEY=$(grep "OPENROUTER_API_KEY=" "ØµØ¯Ø§ÛŒ Ø±Ø§Ø¨ÛŒÙ†/.env" | cut -d'"' -f2 | cut -d'=' -f2)
    if [[ $RABIN_KEY == sk-or-v1-* ]]; then
        echo "âœ… 8ï¸âƒ£  Rabin Voice OpenRouter API Key: ØµØ­ÛŒØ­ ($RABIN_KEY)"
        ((PASSED++))
    else
        echo "âŒ 8ï¸âƒ£  Rabin Voice OpenRouter API Key: Ø§Ø´ØªØ¨Ø§Ù‡ (Ù†Ø¨Ø§ÛŒØ¯ Ø®Ø§Ù„ÛŒ ÛŒØ§ ØºÙ„Ø· Ø¨Ø§Ø´Ø¯)"
        ((FAILED++))
    fi
else
    echo "âŒ 8ï¸âƒ£  Rabin Voice OpenRouter API Key: ÛŒØ§ÙØª Ù†Ø´Ø¯"
    ((FAILED++))
fi

echo -n "9ï¸âƒ£  Root .env OpenRouter Key ØªÙ†Ø¸ÛŒÙ… Ø´Ø¯Ù‡: "
grep -q "OPENROUTER_API_KEY.*sk-or-v1-" .env
check_result $?

echo ""

# =================== Ø¨Ø±Ø±Ø³ÛŒ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Docker ===================
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ³ Ø¨Ø±Ø±Ø³ÛŒ Docker Files"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

echo -n "ğŸ”Ÿ ØµØ¯Ø§ÛŒ Ø±Ø§Ø¨ÛŒÙ†/Dockerfile Ù…ÙˆØ¬ÙˆØ¯: "
[ -f "ØµØ¯Ø§ÛŒ Ø±Ø§Ø¨ÛŒÙ†/Dockerfile" ]
check_result $?

echo -n "1ï¸âƒ£1ï¸âƒ£  ØµØ¯Ø§ÛŒ Ø±Ø§Ø¨ÛŒÙ†/start.sh Ù…ÙˆØ¬ÙˆØ¯: "
[ -f "ØµØ¯Ø§ÛŒ Ø±Ø§Ø¨ÛŒÙ†/start.sh" ]
check_result $?

echo -n "1ï¸âƒ£2ï¸âƒ£  start.sh Ù‚Ø§Ø¨Ù„ Ø§Ø¬Ø±Ø§ Ø§Ø³Øª: "
[ -x "ØµØ¯Ø§ÛŒ Ø±Ø§Ø¨ÛŒÙ†/start.sh" ]
check_result $?

echo -n "1ï¸âƒ£3ï¸âƒ£  Dockerfile Ø±ÙˆÛŒ start.sh Ø§Ø´Ø§Ø±Ù‡ Ø¯Ø§Ø±Ø¯: "
grep -q "CMD.*start.sh" "ØµØ¯Ø§ÛŒ Ø±Ø§Ø¨ÛŒÙ†/Dockerfile"
check_result $?

echo ""

# =================== Ø¨Ø±Ø±Ø³ÛŒ Deployment Scripts ===================
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸš€ Ø¨Ø±Ø±Ø³ÛŒ Deployment Scripts"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

echo -n "1ï¸âƒ£4ï¸âƒ£  deploy-server.sh Ù…ÙˆØ¬ÙˆØ¯: "
[ -f deploy-server.sh ]
check_result $?

echo -n "1ï¸âƒ£5ï¸âƒ£  nginx/active.conf routing Ø¨Ø±Ø§ÛŒ rabin-voice: "
grep -q "/rabin-voice/" nginx/active.conf 2>/dev/null || grep -q "rabin-voice" deploy-server.sh
check_result $?

echo ""

# =================== Ø¨Ø±Ø±Ø³ÛŒ Database Files ===================
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ’¾ Ø¨Ø±Ø±Ø³ÛŒ Database Files"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

echo -n "1ï¸âƒ£6ï¸âƒ£  database/crm_system.sql Ù…ÙˆØ¬ÙˆØ¯: "
[ -f "database/crm_system.sql" ] || [ -f "crm_system.sql" ]
check_result $?

echo ""

# =================== Ø®Ù„Ø§ØµÙ‡ Ù†ØªØ§ÛŒØ¬ ===================
echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘  ğŸ“Š Ø®Ù„Ø§ØµÙ‡ Ù†ØªØ§ÛŒØ¬                                            â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "   âœ… Ù…ÙˆÙÙ‚: $PASSED"
echo "   âŒ Ù†Ø§Ù…ÙˆÙÙ‚: $FAILED"
echo ""

if [ $FAILED -eq 0 ]; then
    echo "âœ… ØªÙ…Ø§Ù… Ú†Ú©â€ŒÙ‡Ø§ Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯Ù†Ø¯! Ù…ÛŒâ€ŒØªÙˆÙ†ÛŒØ¯ deploy Ú©Ù†ÛŒØ¯."
    echo ""
    echo "ğŸ“ Ù…Ø±Ø§Ø­Ù„ Ø¨Ø¹Ø¯ÛŒ:"
    echo "   1. bash deploy-server.sh"
    exit 0
else
    echo "âŒ ØªØ¹Ø¯Ø§Ø¯ÛŒ Ø§Ø² Ú†Ú©â€ŒÙ‡Ø§ Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯Ù†Ø¯!"
    echo ""
    echo "ğŸ”§ Ø±Ø§Ù‡â€ŒØ­Ù„â€ŒÙ‡Ø§ÛŒ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ÛŒ:"
    echo ""
    
    if ! [ -f .env ]; then
        echo "   â€¢ ÙØ§ÛŒÙ„ .env Ø±Ø§ Ø§ÛŒØ¬Ø§Ø¯ Ú©Ù†ÛŒØ¯:"
        echo "     cp .env.server .env"
        echo ""
    fi
    
    if ! grep -q "OPENROUTER_API_KEY.*sk-or-v1-" "ØµØ¯Ø§ÛŒ Ø±Ø§Ø¨ÛŒÙ†/.env"; then
        echo "   â€¢ OpenRouter API Key Ø±Ø§ ØªÙ†Ø¸ÛŒÙ… Ú©Ù†ÛŒØ¯:"
        echo "     1. Ø§Ø² openrouter.ai/keys Ú©Ù¾ÛŒ Ú©Ù†ÛŒØ¯"
        echo "     2. Ø§Ø¬Ø±Ø§ Ú©Ù†ÛŒØ¯: nano ØµØ¯Ø§ÛŒ Ø±Ø§Ø¨ÛŒÙ†/.env"
        echo "     3. OPENROUTER_API_KEY Ø±Ø§ ØªÙ†Ø¸ÛŒÙ… Ú©Ù†ÛŒØ¯"
        echo ""
    fi
    
    if [ $FAILED -gt 0 ]; then
        echo "   â€¢ Ù…Ø¬Ø¯Ø¯ Ø§Ø¬Ø±Ø§ Ú©Ù†ÛŒØ¯: bash diagnose-deployment-issues.sh"
    fi
    
    exit 1
fi