# Stage 1: Base image
FROM node:18-alpine AS base

# Install minimal system dependencies
RUN apk add --no-cache \
    libc6-compat \
    curl \
    bash

# Set locale and encoding
ENV LANG=C.UTF-8
ENV LC_ALL=C.UTF-8

WORKDIR /app

# Ù…Ø±Ø­Ù„Ù‡ 2: Dependencies
FROM base AS deps
COPY package*.json ./
RUN npm install --only=production --prefer-offline --no-audit --progress=false

# Ù…Ø±Ø­Ù„Ù‡ 3: Builder
FROM base AS builder
COPY package*.json ./

# Ù†ØµØ¨ dependencies Ø¨Ø§ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø¨Ù‡ÛŒÙ†Ù‡
RUN npm install --prefer-offline --no-audit --progress=false

# Ú©Ù¾ÛŒ Ú©Ù„ Ù¾Ø±ÙˆÚ˜Ù‡ (Ø¨Ù‡ Ø¬Ø² .env Ú©Ù‡ Ø§Ø² docker-compose Ù…ÛŒâ€ŒØ¢ÛŒØ¯)
COPY . .

# Ø­Ø°Ù .env Ø§Ú¯Ø± ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯ (Ø¨Ø±Ø§ÛŒ Ø§Ù…Ù†ÛŒØª)
RUN rm -f .env 2>/dev/null || true

# Build Ø¨Ø§ memory Ø¨Ù‡ÛŒÙ†Ù‡â€ŒØ´Ø¯Ù‡
ENV NODE_OPTIONS="--max-old-space-size=1024"
ENV NEXT_TELEMETRY_DISABLED=1
ENV CI=true

# Build Next.js Ù…Ø¹ Ù…Ø¹Ø§Ù„Ø¬Ø© BASE_PATH Ùˆ ASSET_PREFIX
RUN npm run build 2>&1 | tee /tmp/build.log || { echo "âŒ Build failed"; cat /tmp/build.log; exit 1; }

# Ù…Ø±Ø­Ù„Ù‡ 4: Runner
FROM base AS runner
ENV NODE_ENV=production
ENV NODE_OPTIONS="--max-old-space-size=512"

RUN addgroup --system --gid 1001 nodejs
RUN adduser --system --uid 1001 nextjs

# Create necessary directories
RUN mkdir -p /app/logs /app/public

# Ú©Ù¾ÛŒ package.json (Ù…ÙˆØ±Ø¯ Ù†ÛŒØ§Ø² Ø¨Ø±Ø§ÛŒ next start fallback)
COPY --from=builder --chown=nextjs:nodejs /app/package*.json ./

# Ú©Ù¾ÛŒ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ public
COPY --from=builder --chown=nextjs:nodejs /app/public ./public

# Ú©Ù¾ÛŒ .next directory (standalone ÛŒØ§ Ø¹Ø§Ø¯ÛŒ - fallback to regular build)
COPY --from=builder --chown=nextjs:nodejs /app/.next ./.next

# ğŸ”§ Ú©Ù¾ÛŒ API directory
COPY --from=builder --chown=nextjs:nodejs /app/api ./api

# ğŸ”§ Ú©Ù¾ÛŒ node_modules Ø§Ø² deps stage (Ø´Ø§Ù…Ù„ express Ùˆ Ø¨Ù‚ÛŒÙ‡ dependencies)
COPY --from=deps --chown=nextjs:nodejs /app/node_modules ./node_modules

# âœ… Set correct permissions for logs and public directories
RUN mkdir -p /app/logs /app/public && \
    chmod -R 777 /app/logs /app/public

# Copy start script
COPY --chown=nextjs:nodejs ./start.sh ./start.sh
RUN chmod +x ./start.sh

USER nextjs

EXPOSE 3001
ENV PORT 3001
ENV HOSTNAME "0.0.0.0"

# Start both Express API and Next.js server
CMD ["./start.sh"]