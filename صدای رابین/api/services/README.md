# 🗄️ Database Integration Layer

این لایه برای تشخیص کلمات کلیدی در متن کاربر و دریافت اطلاعات مرتبط از دیتابیس طراحی شده.

## 🔄 جریان کار

```
کاربر صحبت می‌کنه
       ↓
Web Speech API (تشخیص گفتار)
       ↓
🆕 Keyword Detection & Database Query ← این لایه جدید
       ↓
متن + داده‌های دیتابیس به AI ارسال می‌شه
       ↓
OpenRouter (Claude) پاسخ تولید می‌کنه
       ↓
پاسخ به TTS API ارسال می‌شه
```

## 📁 فایل‌های این لایه

### `database.js`
- اتصال به MySQL دیتابیس
- توابع دریافت اطلاعات (همکاران، مشتریان، فروش، وظایف، پروژه‌ها)
- Connection pooling برای بهتر بودن performance

### `keywordDetector.js`
- تشخیص کلمات کلیدی در متن فارسی
- نگاشت کلمات به عملکردهای دیتابیس
- پردازش و فرمت کردن نتایج

### `dataEnrichment.js` (Middleware)
- غنی‌سازی پیام کاربر با داده‌های دیتابیس
- اضافه کردن context به پیام برای AI
- مدیریت خطاها بدون خراب کردن سیستم

## 🔑 کلمات کلیدی پشتیبانی شده

### کاربران و همکاران
- همکاران، همکار، کارمندان، کارمند، پرسنل، تیم، کاربران، کاربر

### مشتریان  
- مشتریان، مشتری، کلاینت، خریدار، مراجع

### فروش و معاملات
- فروش، فروشات، درآمد، معاملات، معامله، سفارش، سفارشات
- + کلمات زمانی: امروز، هفته، ماه

### فعالیت‌ها و وظایف
- فعالیت، فعالیت‌ها، وظایف، وظیفه، تسک، تسک‌ها، کار، کارها
- + نام همکاران: احمد، احمدرضا، علی، سارا، محمد، آوندی، کریمی

### معاملات (پروژه‌ها)
- پروژه، پروژه‌ها، پروژه های، پرژه

### گزارشات روزانه
- گزارش، گزارشات، گزارش روزانه، گزارشات روزانه

### بازخوردها و نظرات
- بازخورد، بازخوردها، نظرات، نظر، رضایت

### رویدادها و تقویم
- رویداد، رویدادها، جلسه، جلسات، تقویم، قرار

### اسناد و مدارک
- سند، اسناد، مدرک، مدارک، فایل، فایل‌ها

## 🛠️ نصب و راه‌اندازی

```bash
# نصب dependency جدید
npm install mysql2

# تست اتصال دیتابیس
node api/test/testDatabase.js
```

## ⚙️ تنظیمات دیتابیس

```javascript
const DB_CONFIG = {
  host: "181.41.194.136",
  database: "crm_system", 
  user: "crm_app_user",
  password: "Ahmad.1386"
};
```

## 📊 نمونه استفاده

```javascript
// در AI route
router.post('/process', enrichUserMessage, async (req, res) => {
  const { userMessage, enrichedMessage, hasSystemData } = req.body;
  
  // اگر داده‌های سیستم موجود باشد، از enrichedMessage استفاده کن
  const messageToAI = hasSystemData ? enrichedMessage : userMessage;
});
```

## 🔍 مثال‌های کاربردی

### ورودی کاربر:
"لیست همکاران فعال رو نشون بده"

### خروجی سیستم:
```
لیست همکاران فعال رو نشون بده

[اطلاعات سیستم: 
📋 دریافت اطلاعات همکاران:
- تعداد همکاران فعال: 15
- نمونه: احمد رضایی، علی محمدی، سارا احمدی
]
```

## 🛡️ مدیریت خطا

- اگر دیتابیس در دسترس نباشد، سیستم بدون داده ادامه می‌ده
- خطاهای SQL لاگ می‌شن ولی سیستم رو خراب نمی‌کنن
- Timeout برای جلوگیری از hang شدن

## 🚀 بهبودهای آینده

- [ ] Cache کردن نتایج دیتابیس
- [ ] پشتیبانی از کلمات کلیدی بیشتر
- [ ] تشخیص نام‌های شخصی بهتر
- [ ] گزارش‌های پیشرفته‌تر
- [ ] Real-time data updates